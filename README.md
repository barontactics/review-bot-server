# Review Bot Server

A Node.js backend server with Express and TypeORM.

## Setup

1. Install dependencies:
   ```bash
   npm install
   ```

2. Configure database:
   - Copy `.env.example` to `.env`
   - Update database credentials in `.env`

3. Create PostgreSQL database:
   ```bash
   createdb review_bot
   ```

## Running the Server

Development mode (with auto-restart):
```bash
npm run dev
```

Production mode:
```bash
npm start
```

## Running Tests

Run all tests:
```bash
npm test
```

Run tests in watch mode (re-runs on file changes):
```bash
npm run test:watch
```

Run tests with coverage report:
```bash
npm run test:coverage
```

### Test Coverage

The project includes comprehensive unit tests for:
- **UserRepository** - 100% coverage (20 test cases)
- **VideoRepository** - 100% coverage (26 test cases)

Both repositories have **100% statement, branch, function, and line coverage**. Tests are written using Jest and mock the database layer to ensure fast, isolated unit tests.

## Project Structure

```
├── config/
│   ├── database.js          # TypeORM configuration
│   ├── passport.js          # Passport OAuth configuration
│   └── storage.js           # Google Cloud Storage configuration
├── src/
│   ├── entities/            # Database models
│   │   ├── User.js          # User entity (with OAuth fields)
│   │   └── Video.js         # Video entity
│   ├── middleware/          # Express middleware
│   │   ├── auth.js          # Authentication middleware
│   │   ├── logger.js        # Request logging middleware
│   │   └── upload.js        # Multer file upload middleware
│   ├── repositories/        # Database repositories
│   │   ├── __tests__/       # Repository unit tests
│   │   │   ├── UserRepository.test.js
│   │   │   └── VideoRepository.test.js
│   │   ├── UserRepository.js  # User repository with helper methods
│   │   └── VideoRepository.js # Video repository with helper methods
│   ├── routes/              # Express routes
│   │   ├── auth.js          # OAuth routes (Google, Discord)
│   │   ├── users.js         # User routes
│   │   └── videos.js        # Video upload/retrieval routes
│   ├── subscribers/         # Database event subscribers
│   │   └── UserSubscriber.js # Auto-hash passwords on save
│   ├── utils/               # Utility functions
│   │   └── password.js      # Password hashing utilities
│   └── migrations/          # Database migrations
├── examples/                # Example usage files
│   └── user-operations.js   # User repository examples
├── server.js                # Main application entry point
├── jest.config.js           # Jest testing configuration
├── .env                     # Environment variables (not in git)
├── .env.example             # Environment variables template
└── package.json
```

## Database Models

### Password Security

**All passwords are automatically hashed using bcrypt before being stored in the database.**

The `UserSubscriber` automatically hashes passwords:
- Before user creation (insert)
- Before user updates (only if password changed)

### Using the UserRepository

The UserRepository provides convenient methods for user operations:

```javascript
const UserRepository = require('./src/repositories/UserRepository');

// Create a user (password will be auto-hashed)
const newUser = await UserRepository.createUser({
  username: 'john_doe',
  email: 'john@example.com',
  password: 'plain_text_password', // Will be automatically hashed
});

// Authenticate a user
const user = await UserRepository.authenticate('john@example.com', 'plain_text_password');
if (user) {
  console.log('Login successful!', user); // Password is excluded from returned object
} else {
  console.log('Invalid credentials');
}

// Find user by email
const user = await UserRepository.findByEmail('john@example.com');

// Find user by username
const user = await UserRepository.findByUsername('john_doe');

// Update user
const updatedUser = await UserRepository.updateUser(userId, {
  email: 'newemail@example.com',
});

// Get all users (passwords excluded)
const users = await UserRepository.findAll();

// Delete user
await UserRepository.deleteUser(userId);
```

### Using TypeORM Repository Directly

You can also use TypeORM repositories directly:

```javascript
const { AppDataSource } = require('./config/database');

// Get repository
const userRepository = AppDataSource.getRepository('User');

// Create a user (password will be auto-hashed by UserSubscriber)
const user = userRepository.create({
  username: 'john_doe',
  email: 'john@example.com',
  password: 'plain_text_password',
});
await userRepository.save(user);

// Find users
const users = await userRepository.find();
const userById = await userRepository.findOneBy({
  id: '550e8400-e29b-41d4-a716-446655440000'
});
```

**Note:** User IDs are UUIDs (v4), automatically generated by PostgreSQL.

### Video Entity

The Video entity stores information about uploaded videos.

**Fields:**
- `id` - Primary key UUID (auto-generated)
- `title` - Video title (required)
- `description` - Video description (optional)
- `url` - Video URL/path (required)
- `thumbnailUrl` - Thumbnail image URL (optional)
- `duration` - Video duration in seconds (optional)
- `fileSize` - File size in bytes (optional)
- `mimeType` - MIME type (e.g., "video/mp4") (optional)
- `status` - Processing status: pending, processing, completed, failed (default: pending)
- `userId` - Foreign key UUID to User table (required)
- `createdAt` - Timestamp when created
- `updatedAt` - Timestamp when last updated

**Relationships:**
- **Many-to-One** with User (each video belongs to one user)
- Cascade delete enabled (deleting a user deletes their videos)

**Example Usage:**
```javascript
const { AppDataSource } = require('./config/database');

// Get repository
const videoRepository = AppDataSource.getRepository('Video');

// Create a video
const video = videoRepository.create({
  title: 'My First Video',
  description: 'This is a test video',
  url: '/uploads/video123.mp4',
  thumbnailUrl: '/uploads/thumb123.jpg',
  duration: 120,
  fileSize: 5242880,
  mimeType: 'video/mp4',
  status: 'completed',
  userId: '550e8400-e29b-41d4-a716-446655440000',
});
await videoRepository.save(video);

// Find videos by user
const userVideos = await videoRepository.find({
  where: { userId: '550e8400-e29b-41d4-a716-446655440000' },
  order: { createdAt: 'DESC' },
});

// Find video with user information
const videoWithUser = await videoRepository.findOne({
  where: { id: '650e8400-e29b-41d4-a716-446655440001' },
  relations: ['user'],
});
```

## Environment Variables

### Server Configuration
- `PORT` - Server port (default: 3000)
- `NODE_ENV` - Environment (development/production)

### Session & CORS
- `SESSION_SECRET` - Secret key for session encryption (change in production!)
- `CLIENT_URL` - Client URL for CORS (default: http://localhost:3000)
- `CALLBACK_URL` - Base URL for OAuth callbacks (default: http://localhost:3000)

### OAuth (Optional)
- `GOOGLE_CLIENT_ID` - Google OAuth Client ID
- `GOOGLE_CLIENT_SECRET` - Google OAuth Client Secret
- `DISCORD_CLIENT_ID` - Discord OAuth Client ID
- `DISCORD_CLIENT_SECRET` - Discord OAuth Client Secret

### Database
- `DB_HOST` - Database host
- `DB_PORT` - Database port (default: 5432)
- `DB_USERNAME` - Database username
- `DB_PASSWORD` - Database password
- `DB_NAME` - Database name

### Google Cloud Storage (Video Storage)
- `GCP_PROJECT_ID` - GCP project ID
- `GCP_KEY_FILE` - Path to service account JSON key file (optional if using ADC)
- `GCS_BUCKET_NAME` - GCS bucket name (default: review-bot-videos)

## Request Logging

The application includes a custom logging middleware that logs all incoming HTTP requests to the console.

### Logged Information:
- **Timestamp** - ISO 8601 format
- **HTTP Method** - GET, POST, PUT, DELETE, etc. (color-coded)
- **Status Code** - Response status (color-coded)
- **Response Time** - Duration in milliseconds
- **URL** - Request path
- **IP Address** - Client IP address

### Example Output:
```
2024-01-15T10:30:00.000Z | GET     | 200 | 15ms | /api/user/550e8400-e29b-41d4-a716-446655440000 | ::1
2024-01-15T10:30:05.000Z | POST    | 201 | 245ms | /api/videos/upload | ::1
2024-01-15T10:30:10.000Z | DELETE  | 200 | 89ms | /api/videos/650e8400-e29b-41d4-a716-446655440001 | ::1
```

### Color Coding:
- **Status Codes:**
  - 2xx (Success) - Green
  - 3xx (Redirect) - Cyan
  - 4xx (Client Error) - Yellow
  - 5xx (Server Error) - Red
- **HTTP Methods:**
  - GET - Blue
  - POST - Green
  - PUT/PATCH - Yellow
  - DELETE - Red

## Authentication

The application uses **session-based authentication** with `express-session`.

### How It Works

1. User logs in via `POST /api/login` with email and password
2. Server validates credentials and creates a session
3. Session ID is stored in a cookie (`connect.sid`)
4. Protected routes use the `requireAuth` middleware to verify the session
5. User must include the session cookie in subsequent requests

### Authentication Middleware

Located in `src/middleware/auth.js`:

- **`requireAuth`** - Blocks unauthenticated requests (returns 401)
- **`checkAuth`** - Optional auth check (sets `req.isAuthenticated` flag)

**Example Usage:**
```javascript
const { requireAuth } = require('../middleware/auth');

// Protected route - requires login
router.get('/protected', requireAuth, (req, res) => {
  res.json({ userId: req.session.userId });
});
```

### Session Configuration

- **Duration:** 24 hours
- **Cookie Settings:**
  - `httpOnly: true` - Prevents JavaScript access to cookie
  - `secure: true` - HTTPS only (in production)
- **Session Secret:** Set via `SESSION_SECRET` environment variable

## API Endpoints

### General
- `GET /` - Welcome message
- `GET /health` - Health check endpoint

### Users

#### GET /api/user/:id
Get user by ID

**Authentication Required:** Yes (must be logged in)

**Example:**
```bash
# Must include session cookie from login
curl http://localhost:3000/api/user/550e8400-e29b-41d4-a716-446655440000 \
  -H "Cookie: connect.sid=your-session-cookie"
```

**Success Response (200):**
```json
{
  "success": true,
  "data": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "email": "user@example.com",
    "createdAt": "2024-01-15T10:30:00.000Z",
    "updatedAt": "2024-01-15T10:30:00.000Z"
  }
}
```

**Error Responses:**
- `400 Bad Request` - Invalid user ID format (must be valid UUID)
- `401 Unauthorized` - Not logged in
- `404 Not Found` - User doesn't exist
- `500 Internal Server Error` - Server error

---

#### POST /api/login
Authenticate a user with email and password

**Request Body:**
```json
{
  "email": "user@example.com",
  "password": "mypassword123"
}
```

**Example:**
```bash
curl -X POST http://localhost:3000/api/login \
  -H "Content-Type: application/json" \
  -d '{"email":"user@example.com","password":"mypassword123"}'
```

**Success Response (200):**
```json
{
  "success": true,
  "message": "Login successful",
  "data": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "email": "user@example.com",
    "createdAt": "2024-01-15T10:30:00.000Z",
    "updatedAt": "2024-01-15T10:30:00.000Z"
  }
}
```

**Error Responses:**
- `400 Bad Request` - Missing required fields or invalid email format
- `401 Unauthorized` - Invalid email or password
- `500 Internal Server Error` - Server error

---

#### POST /api/signup
Create a new user account

**Request Body:**
```json
{
  "email": "newuser@example.com",
  "password": "securepassword123"
}
```

**Example:**
```bash
curl -X POST http://localhost:3000/api/signup \
  -H "Content-Type: application/json" \
  -d '{"email":"newuser@example.com","password":"securepassword123"}'
```

**Success Response (201):**
```json
{
  "success": true,
  "message": "Account created successfully",
  "data": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "email": "newuser@example.com",
    "createdAt": "2024-01-15T10:30:00.000Z",
    "updatedAt": "2024-01-15T10:30:00.000Z"
  }
}
```

**Error Responses:**
- `400 Bad Request` - Missing required fields, invalid email format, or weak password
- `409 Conflict` - User with this email already exists
- `500 Internal Server Error` - Server error

**Notes:**
- Password must be at least 8 characters long
- Password is automatically hashed using bcrypt before storage
- User is automatically logged in after signup (session created)
- User IDs are UUIDs (universally unique identifiers), not sequential integers

---

### Videos

#### POST /api/videos/upload
Upload a video file to S3

**Authentication Required:** Yes (must be logged in)

**Request:**
- Content-Type: multipart/form-data
- Body:
  - `video` (file, required) - Video file to upload
  - `title` (string, optional) - Video title (defaults to filename)
  - `description` (string, optional) - Video description

**Example:**
```bash
curl -X POST http://localhost:3000/api/videos/upload \
  -H "Cookie: connect.sid=your-session-cookie" \
  -F "video=@/path/to/video.mp4" \
  -F "title=My Video" \
  -F "description=This is a test video"
```

**Success Response (201):**
```json
{
  "success": true,
  "message": "Video uploaded successfully",
  "data": {
    "id": "650e8400-e29b-41d4-a716-446655440001",
    "title": "My Video",
    "description": "This is a test video",
    "url": "https://storage.googleapis.com/review-bot-videos/550e8400-e29b-41d4-a716-446655440000/1234567890-abc123.mp4",
    "fileSize": 5242880,
    "mimeType": "video/mp4",
    "status": "completed",
    "userId": "550e8400-e29b-41d4-a716-446655440000",
    "createdAt": "2024-01-15T10:30:00.000Z",
    "updatedAt": "2024-01-15T10:30:00.000Z"
  }
}
```

**Error Responses:**
- `400 Bad Request` - No video file provided or invalid file type
- `401 Unauthorized` - Not logged in
- `500 Internal Server Error` - Upload failed

**Notes:**
- Maximum file size: 500MB
- Allowed formats: mp4, mpeg, mov, avi, wmv, webm, flv, mkv
- Videos are stored in GCS with user ID as folder name
- Video metadata is saved to database

---

#### GET /api/videos/:id
Get a single video by ID with pre-signed URL

**Authentication Required:** Yes (must be logged in)

**Example:**
```bash
curl http://localhost:3000/api/videos/650e8400-e29b-41d4-a716-446655440001 \
  -H "Cookie: connect.sid=your-session-cookie"
```

**Success Response (200):**
```json
{
  "success": true,
  "data": {
    "id": "650e8400-e29b-41d4-a716-446655440001",
    "title": "My Video",
    "description": "This is a test video",
    "url": "https://storage.googleapis.com/review-bot-videos/550e8400-e29b-41d4-a716-446655440000/1234567890-abc123.mp4",
    "signedUrl": "https://storage.googleapis.com/review-bot-videos/550e8400-e29b-41d4-a716-446655440000/1234567890-abc123.mp4?X-Goog-Algorithm=...",
    "fileSize": 5242880,
    "mimeType": "video/mp4",
    "status": "completed",
    "userId": "550e8400-e29b-41d4-a716-446655440000",
    "createdAt": "2024-01-15T10:30:00.000Z",
    "updatedAt": "2024-01-15T10:30:00.000Z"
  }
}
```

**Error Responses:**
- `400 Bad Request` - Invalid video ID format (must be valid UUID)
- `401 Unauthorized` - Not logged in
- `404 Not Found` - Video doesn't exist
- `500 Internal Server Error` - Server error

**Notes:**
- The `signedUrl` is a signed GCS URL valid for 1 hour
- Use the `signedUrl` to access/download the video file

---

#### GET /api/videos/user/:userId
Get all videos for a specific user

**Authentication Required:** Yes (must be logged in)

**Example:**
```bash
curl http://localhost:3000/api/videos/user/550e8400-e29b-41d4-a716-446655440000 \
  -H "Cookie: connect.sid=your-session-cookie"
```

**Success Response (200):**
```json
{
  "success": true,
  "data": [
    {
      "id": "650e8400-e29b-41d4-a716-446655440001",
      "title": "My Video",
      "description": "This is a test video",
      "url": "https://storage.googleapis.com/review-bot-videos/550e8400-e29b-41d4-a716-446655440000/1234567890-abc123.mp4",
      "fileSize": 5242880,
      "mimeType": "video/mp4",
      "status": "completed",
      "userId": "550e8400-e29b-41d4-a716-446655440000",
      "createdAt": "2024-01-15T10:30:00.000Z",
      "updatedAt": "2024-01-15T10:30:00.000Z"
    }
  ]
}
```

**Error Responses:**
- `400 Bad Request` - Invalid user ID format (must be valid UUID)
- `401 Unauthorized` - Not logged in
- `500 Internal Server Error` - Server error

**Notes:**
- Videos are returned in descending order by creation date (newest first)

---

#### DELETE /api/videos/:id
Delete a video (removes from both GCS and database)

**Authentication Required:** Yes (must be logged in and own the video)

**Example:**
```bash
curl -X DELETE http://localhost:3000/api/videos/650e8400-e29b-41d4-a716-446655440001 \
  -H "Cookie: connect.sid=your-session-cookie"
```

**Success Response (200):**
```json
{
  "success": true,
  "message": "Video deleted successfully"
}
```

**Error Responses:**
- `400 Bad Request` - Invalid video ID format (must be valid UUID)
- `401 Unauthorized` - Not logged in
- `403 Forbidden` - You don't own this video
- `404 Not Found` - Video doesn't exist
- `500 Internal Server Error` - Server error

---

### OAuth Authentication

#### GET /api/auth/google
Initiate Google OAuth login

**Example:**
```bash
# Redirect user to this URL
http://localhost:3000/api/auth/google
```

User will be redirected to Google for authentication, then back to your app at `/auth/success`.

---

#### GET /api/auth/discord
Initiate Discord OAuth login

**Example:**
```bash
# Redirect user to this URL
http://localhost:3000/api/auth/discord
```

User will be redirected to Discord for authentication, then back to your app at `/auth/success`.

---

#### GET /api/auth/me
Get current authenticated user info

**Authentication Required:** Yes

**Example:**
```bash
curl http://localhost:3000/api/auth/me \
  -H "Cookie: connect.sid=your-session-cookie"
```

**Success Response (200):**
```json
{
  "success": true,
  "data": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "email": "user@example.com",
    "authProvider": "google",
    "googleId": "1234567890",
    "createdAt": "2024-01-15T10:30:00.000Z",
    "updatedAt": "2024-01-15T10:30:00.000Z"
  }
}
```

---

#### POST /api/auth/logout
Logout current user

**Example:**
```bash
curl -X POST http://localhost:3000/api/auth/logout \
  -H "Cookie: connect.sid=your-session-cookie"
```

**Success Response (200):**
```json
{
  "success": true,
  "message": "Logged out successfully"
}
```

---

## Google Cloud Storage Setup

### Prerequisites

1. A Google Cloud Platform (GCP) account
2. A GCP project
3. A GCS bucket for storing videos

### Creating a GCS Bucket

1. Go to [Google Cloud Console](https://console.cloud.google.com)
2. Select or create a project
3. Navigate to **Cloud Storage** → **Buckets**
4. Click **Create Bucket**
5. Configure bucket settings:
   - **Name**: Enter a globally unique name (e.g., `review-bot-videos`)
   - **Location type**: Choose based on your needs (Region, Dual-region, or Multi-region)
   - **Storage class**: Standard (recommended for frequently accessed videos)
   - **Access control**: Uniform (recommended)
   - **Public access prevention**: Enforce public access prevention (we'll use signed URLs)
6. Click **Create**

### Setting Up Authentication

You have two options for authentication:

#### Option 1: Service Account Key File (Recommended for Development)

1. Go to [Google Cloud Console](https://console.cloud.google.com)
2. Navigate to **IAM & Admin** → **Service Accounts**
3. Click **Create Service Account**
4. Enter service account details:
   - **Name**: `review-bot-storage` (or your preferred name)
   - **Description**: Service account for video storage access
5. Click **Create and Continue**
6. Grant the **Storage Object Admin** role
7. Click **Continue** and **Done**
8. Click on the newly created service account
9. Go to the **Keys** tab
10. Click **Add Key** → **Create new key**
11. Select **JSON** and click **Create**
12. Save the downloaded JSON file securely
13. Add to `.env`:
    ```
    GCP_PROJECT_ID=your-project-id
    GCP_KEY_FILE=/path/to/service-account-key.json
    GCS_BUCKET_NAME=review-bot-videos
    ```

#### Option 2: Application Default Credentials (Recommended for Production)

For production deployments on GCP (Cloud Run, App Engine, GCE, GKE), use ADC:

1. Ensure your compute resource has the **Storage Object Admin** role
2. Add to `.env`:
    ```
    GCP_PROJECT_ID=your-project-id
    GCS_BUCKET_NAME=review-bot-videos
    ```
3. The `@google-cloud/storage` library will automatically use ADC

### Granting Bucket Permissions

If you need to grant specific permissions, use these roles:

- **Storage Object Admin** (`roles/storage.objectAdmin`): Full control over objects
- **Storage Object Creator** (`roles/storage.objectCreator`): Upload only
- **Storage Object Viewer** (`roles/storage.objectViewer`): Read only

### Custom IAM Role (Optional)

For minimal permissions, create a custom role with only required permissions:

```
storage.objects.create
storage.objects.delete
storage.objects.get
storage.objects.list
```

### GCS Features

- **Automatic Upload**: Videos are automatically uploaded to GCS when using the upload endpoint
- **User Organization**: Videos are stored in folders named after user IDs
- **Signed URLs**: Secure, temporary URLs are generated for video access (1-hour expiration)
- **File Validation**: Only video files are accepted (mp4, mov, avi, etc.)
- **Size Limits**: Maximum upload size is 500MB
- **Automatic Cleanup**: Deleting a video removes it from both the database and GCS

---

## OAuth Setup

### Google OAuth Setup

1. Go to [Google Cloud Console](https://console.cloud.google.com)
2. Create a new project or select existing one
3. Enable Google+ API
4. Go to "Credentials" → "Create Credentials" → "OAuth client ID"
5. Select "Web application"
6. Add authorized redirect URIs:
   - `http://localhost:3000/api/auth/google/callback` (development)
   - `https://yourdomain.com/api/auth/google/callback` (production)
7. Copy Client ID and Client Secret to `.env`:
   ```
   GOOGLE_CLIENT_ID=your-client-id
   GOOGLE_CLIENT_SECRET=your-client-secret
   ```

### Discord OAuth Setup

1. Go to [Discord Developer Portal](https://discord.com/developers/applications)
2. Create a new application
3. Go to "OAuth2" section
4. Add redirect URIs:
   - `http://localhost:3000/api/auth/discord/callback` (development)
   - `https://yourdomain.com/api/auth/discord/callback` (production)
5. Copy Client ID and Client Secret to `.env`:
   ```
   DISCORD_CLIENT_ID=your-client-id
   DISCORD_CLIENT_SECRET=your-client-secret
   ```

### OAuth Features

- **Automatic Account Creation:** New users are automatically created on first OAuth login
- **Account Linking:** If a user with the same email exists, OAuth provider is linked to existing account
- **Multiple Providers:** Users can link multiple OAuth providers to one account
- **No Password Required:** OAuth users don't need a password
- **Secure:** OAuth tokens are validated server-side
